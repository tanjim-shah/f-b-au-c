name: Facebook Post Automation

on:
  schedule:
    # Every 2 hours at minute 0
    - cron: '0 */2 * * *'
    # Every 30 minutes
    - cron: '*/30 * * * *'
  workflow_dispatch:
    inputs:
      task:
        description: 'Task to run (generate or post)'
        required: true
        default: 'generate'
        type: choice
        options:
          - generate
          - post

jobs:
  determine_task:
    runs-on: ubuntu-latest
    outputs:
      run_task: ${{ steps.set-task.outputs.task }}
    steps:
      - id: set-task
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "task=${{ github.event.inputs.task }}" >> $GITHUB_OUTPUT
          else
            MIN=$(date +%M)
            HOUR=$(date +%H)
            if [[ $((MIN % 60)) -eq 0 && $((HOUR % 2)) -eq 0 ]]; then
              echo "task=generate" >> $GITHUB_OUTPUT
            else
              echo "task=post" >> $GITHUB_OUTPUT
            fi
          fi

  generate_posts:
    needs: determine_task
    if: needs.determine_task.outputs.run_task == 'generate'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-genai requests Pillow

      - name: Generate Facebook posts
        run: python .github/scripts/generate_facebook_posts.py
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Commit changes
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add data/urls.txt data/processed_urls.txt data/pending_posts.csv
          git diff --cached --quiet || git commit -m "Generate new Facebook posts: $(date)"
          git push

  post_to_facebook:
    needs: determine_task
    if: needs.determine_task.outputs.run_task == 'post'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Add random delay (0â€“10 mins)
        if: github.event_name == 'schedule'
        run: |
          DELAY=$((RANDOM % 600))
          echo "Sleeping for $DELAY seconds to randomize post timing..."
          sleep $DELAY

      - name: Post to Facebook
        run: python .github/scripts/post_to_facebook.py
        env:
          FACEBOOK_PAGE_ID: ${{ secrets.FACEBOOK_PAGE_ID }}
          FACEBOOK_ACCESS_TOKEN: ${{ secrets.FACEBOOK_ACCESS_TOKEN }}

      - name: Commit post status
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add data/pending_posts.csv
          git diff --cached --quiet || git commit -m "Update Facebook post status: $(date)"
          git push
